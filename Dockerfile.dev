FROM oven/bun:1 AS base

# Setup Node.js per compatibilit√† Prisma
RUN apt update && apt install -y curl
ARG NODE_VERSION=20
RUN curl -L https://raw.githubusercontent.com/tj/n/master/bin/n -o n \
    && bash n $NODE_VERSION \
    && rm n \
    && npm install -g n

WORKDIR /usr/src/app

# Copy package files first per Docker layer caching
COPY package.json bun.lockb ./

# Install dependencies
RUN bun install

# Copy prisma schema
COPY prisma ./prisma

# Generate Prisma client
RUN npx prisma generate

# Copy source code
COPY . .

# Expose port
EXPOSE 3003

# Default command for development with hot reload
CMD ["bun", "--hot", "index.ts"]